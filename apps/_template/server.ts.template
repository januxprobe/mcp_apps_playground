import {
  registerAppResource,
  registerAppTool,
  RESOURCE_MIME_TYPE,
} from "@modelcontextprotocol/ext-apps/server";
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { z } from "zod";
import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const DIST_DIR = path.join(__dirname, "..", "..", "dist", "{{APP_ID}}");

// Export constants for multi-app integration
export const APP_NAME = "{{APP_NAME}}";
export const APP_VERSION = "1.0.0";

// OPTIONAL: Multilingual support
// Uncomment and customize the following for multilingual apps:
//
// type Language = 'en' | 'nl' | 'fr';  // Add your supported languages
//
// const TRANSLATIONS = {
//   en: {
//     toolResponse: "Result processed successfully",
//     // Add more translations...
//   },
//   nl: {
//     toolResponse: "Resultaat succesvol verwerkt",
//   },
//   fr: {
//     toolResponse: "Résultat traité avec succès",
//   },
// };
//
// See apps/hospi-copilot for a complete multilingual implementation example.
// See infrastructure/server/i18n.ts for reusable utilities.

/**
 * Creates and configures the MCP server with tools and UI resource
 */
export function createServer(): McpServer {
  const server = new McpServer({
    name: APP_NAME,
    version: APP_VERSION,
  });

  // Define UI resource URI (acts as cache key - version it for breaking changes)
  const resourceUri = "ui://{{APP_ID}}/widget.html";

  // TODO: Register your tools here
  // Example tool registration:
  registerAppTool(
    server,
    "{{TOOL_NAME}}",  // Machine-readable tool name
    {
      title: "{{TOOL_TITLE}}",  // Human-readable title shown in ChatGPT
      description: "{{TOOL_DESCRIPTION}}",
      inputSchema: {
        // TODO: Define input parameters using Zod
        // Example:
        text: z.string().describe("Example input parameter"),
        // number: z.number().describe("Example number parameter"),
        // optional: z.string().optional().describe("Optional parameter"),

        // OPTIONAL: For multilingual apps, add a language parameter:
        // language: z.enum(["en", "nl", "fr"]).optional().default("en")
        //   .describe("UI language: en (English), nl (Dutch), fr (French). Detect from user's prompt language."),
      },
      annotations: {
        readOnlyHint: true,      // Set to false if tool modifies state
        openWorldHint: false,    // Set to true if tool accesses external systems
        destructiveHint: false,  // Set to true if tool deletes or modifies data
      },
      _meta: {
        ui: {
          resourceUri,  // Links this tool to the UI component
        },
      },
    },
    async (args) => {
      // TODO: Implement your tool logic
      console.error(`{{TOOL_NAME}} called with:`, args);

      // Example: Extract parameters
      // const { text } = args;

      // Example: Do some processing
      // const result = text.toUpperCase();

      return {
        // Structured data for both model and UI consumption
        structuredContent: {
          // TODO: Return data that both the model and UI can use
          // This is GUARANTEED to reach the widget
          input: args,
          // result: result,
          timestamp: new Date().toISOString(),
        },
        // Optional narrative for the model's response
        content: [
          {
            type: "text",
            text: "TODO: Return a narrative description for the model",
          },
        ],
        // Optional: Large/sensitive data exclusively for the UI
        // Note: _meta may not be passed to the widget by ChatGPT
        // Always include critical data in structuredContent
        _meta: {
          // debugInfo: "Extra data for debugging",
        },
      };
    }
  );

  // TODO: Add more tools if needed
  // Just copy the registerAppTool block above and modify it

  // Register the UI resource
  registerAppResource(
    server,
    "{{APP_ID}}-widget",  // Resource name
    resourceUri,          // Must match the tool's resourceUri
    { mimeType: RESOURCE_MIME_TYPE },  // text/html;profile=mcp-app
    async () => {
      console.error(`Serving UI resource from: ${DIST_DIR}/widget/{{APP_ID}}-widget.html`);

      // Read the bundled HTML from dist directory
      const html = await fs.readFile(
        path.join(DIST_DIR, "widget", "{{APP_ID}}-widget.html"),
        "utf-8"
      );

      return {
        contents: [
          {
            uri: resourceUri,
            mimeType: RESOURCE_MIME_TYPE,
            text: html,
          },
        ],
      };
    }
  );

  console.error(`${APP_NAME} created with tools and resources`);

  return server;
}
